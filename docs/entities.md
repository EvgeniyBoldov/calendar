# Доменные сущности и атрибуты

Этот документ описывает основные доменные сущности бэкенда (модели в `app/models`) и смысл их атрибутов.

---

## 1. Базовые

### 1.1. Base и TimestampMixin

- **`Base`**  
  Базовый класс для всех ORM‑моделей (SQLAlchemy DeclarativeBase).

- **`TimestampMixin`**  
  Миксин с полями аудита:
  - `created_at` — дата и время создания записи.
  - `updated_at` — дата и время последнего изменения записи.

---

## 2. География и инфраструктура

### 2.1. Region

**Таблица:** `regions`

- `id` — UUID, первичный ключ.
- `name` — название региона (строка).

**Связи:**
- `data_centers` — дата‑центры, расположенные в регионе.
- `engineers` — инженеры, закреплённые за регионом.

### 2.2. DataCenter

**Таблица:** `data_centers`

- `id` — UUID, первичный ключ.
- `name` — название дата‑центра.
- `description` — описание (опционально).
- `region_id` — ссылка на регион (`Region.id`), обязательна.

**Связи:**
- `region` — регион, к которому относится ДЦ.
- `works` — работы/сопровождения (`Work`), привязанные к этому ДЦ.

### 2.3. DistanceMatrix

**Таблица:** `distance_matrix`

Модель для хранения времени переезда между ДЦ.

- `id` — UUID, первичный ключ.
- `from_dc_id` — исходный дата‑центр (`DataCenter.id`).
- `to_dc_id` — целевой дата‑центр (`DataCenter.id`).
- `duration_minutes` — время переезда в минутах.

**Связи:**
- `from_dc` — объект `DataCenter` для `from_dc_id`.
- `to_dc` — объект `DataCenter` для `to_dc_id`.

**Ограничения:**
- Уникальный составной индекс `uix_from_to_dc` на пару (`from_dc_id`, `to_dc_id`).

---

## 3. Пользователи и инженеры

### 3.1. UserRole (enum)

Роли пользователей в системе:

- `ADMIN` — Администратор. Полный доступ, управление пользователями.
- `EXPERT` — Эксперт. Планирование работ, управление инженерами и ДЦ.
- `TRP` — Заказчик (ТРП). Создание и редактирование своих работ.
- `ENGINEER` — Инженер. Просмотр и выполнение назначенных работ.

### 3.2. User

**Таблица:** `users`

- `id` — UUID, первичный ключ.
- `login` — уникальный логин пользователя (для авторизации).
- `email` — email, уникальный и обязательный.
- `full_name` — ФИО пользователя (опционально).
- `role` — роль пользователя (`UserRole`).
- `is_active` — флаг активности (для блокировки пользователей).
- `password_hash` — хэш пароля (bcrypt, для локальной авторизации).

**Связи:**
- `created_works` — работы (`Work`), созданные этим пользователем.
- `refresh_tokens` — refresh-токены пользователя (`RefreshToken`).
- `engineer` — связанный инженер (`Engineer`), если пользователь — инженер.

### 3.3. RefreshToken

**Таблица:** `refresh_tokens`

Хранит refresh-токены для JWT-аутентификации.

- `id` — UUID, первичный ключ.
- `user_id` — пользователь (`User.id`).
- `jti` — уникальный идентификатор токена (JWT ID).
- `revoked` — флаг отзыва токена.
- `expires_at` — время истечения токена.
- `created_at` — время создания.
- `user_agent` — User-Agent клиента (для аудита).
- `ip_address` — IP-адрес клиента (для аудита).

**Связи:**
- `user` — владелец токена (`User`).

### 3.4. Engineer

**Таблица:** `engineers`

- `id` — UUID, первичный ключ.
- `name` — имя / ФИО инженера.
- `region_id` — регион, в котором работает инженер (`Region.id`).
- `user_id` — связанный пользователь (`User.id`, опционально). Позволяет инженеру входить в систему.

**Связи:**
- `region` — регион инженера.
- `time_slots` — рабочие временные слоты инженера (`TimeSlot`).
- `assigned_chunks` — этапы (`WorkChunk`), назначенные этому инженеру.
- `user` — пользователь (`User`), связанный с инженером.

### 3.5. TimeSlot

**Таблица:** `time_slots`

Представляет доступность инженера в конкретный день.

- `id` — UUID, первичный ключ.
- `engineer_id` — ссылка на инженера (`Engineer.id`).
- `date` — дата слота.
- `start_hour` — час начала (0–23).
- `end_hour` — час окончания (0–23).

**Связи:**
- `engineer` — владелец слота (`Engineer`).

---

## 4. Работы, этапы и задачи

### 4.1. Основные enum’ы

Определены в моделях `work.py` и схемах `schemas/work.py`.

- **`Priority`** — приоритет работы:
  - `low`, `medium`, `high`, `critical`.

- **`WorkType`** — тип работы:
  - `general` — работа с планом (проект, набор этапов и задач).
  - `support` — сопровождение (выезд в конкретный день).

- **`WorkStatus`** — статус работы (общее множество):
  - `draft`, `created`, `ready`, `scheduling`, `assigned`, `in_progress`, `completed`.
  - Планируемый дополнительный статус: `documented` — завершённая и задокументированная работа.

- **`ChunkStatus`** — статус этапа (`WorkChunk`):
  - `created`, `planned`, `assigned`, `in_progress`, `completed`.

- **`TaskStatus`** — статус задачи (`WorkTask`):
  - `todo`, `done`, `partial`, `cancelled`.

- **`ChunkLinkType`** — тип связи между этапами:
  - `sync` — синхронные этапы (должны выполняться одновременно).
  - `dependency` — зависимость (этап B после завершения этапа A).

### 4.2. Work

**Таблица:** `works`

Представляет «Работу» или «Сопровождение».

- **Идентификация и базовые поля**
  - `id` — UUID, первичный ключ.
  - `name` — название работы.
  - `description` — текстовое описание (опционально).

- **Тип и приоритет**
  - `work_type` — тип работы (`WorkType`): `general` или `support`.
  - `priority` — приоритет (`Priority`).
  - `status` — текущий статус работы (`WorkStatus`).

- **Для типа `general` (работа с планом)**
  - `due_date` — дедлайн работы (опционально).

- **Для типа `support` (сопровождение)**
  - `data_center_id` — дата‑центр, где выполняется сопровождение (обязателен).
  - `target_date` — дата выезда.
  - `target_time` — час начала (0–23, опционально).
  - `duration_hours` — продолжительность выезда в часах (обычно 1–12).
  - `contact_info` — контактное лицо/телефон для согласования.

- **Технические поля**
  - `version` — версия записи для оптимистичной блокировки.
  - `author_id` — пользователь‑автор (`User.id`, опционально).

**Связи:**
- `data_center` — объект `DataCenter`, если работа/сопровождение привязана к ДЦ.
- `author` — пользователь (`User`), создавший работу.
- `tasks` — список задач (`WorkTask`) внутри работы.
- `chunks` — список этапов (`WorkChunk`), используемых для назначения инженерам.
- `attachments` — вложения (`WorkAttachment`), связанные с работой.

### 4.3. WorkChunk

**Таблица:** `work_chunks`

Этап работы — группа задач, которая планируется как единое целое и назначается инженеру.

- **Идентификация и базовые поля**
  - `id` — UUID, первичный ключ.
  - `work_id` — ссылка на родительскую работу (`Work.id`).
  - `title` — название этапа.
  - `description` — описание этапа (опционально).
  - `order` — порядковый номер этапа внутри работы.
  - `status` — статус этапа (`ChunkStatus`).

- **Привязка к инфраструктуре**
  - `data_center_id` — ДЦ этапа (может отличаться от `work.data_center_id`).

- **Назначение инженера**
  - `assigned_engineer_id` — инженер, на которого назначен этап (если уже есть назначение).
  - `assigned_date` — дата выполнения этапа.
  - `assigned_start_time` — час начала.

- **Технические поля**
  - `version` — версия записи для оптимистичной блокировки.

- **Вычисляемые/сервисные поля (через свойства/схемы)**
  - `duration_hours` — суммарная длительность этапа, как сумма по задачам (`estimated_hours * quantity`).
  - `constraints` — объект ограничений для планирования (окно дат, регион, зависимости и т.п.).
  - `links` — связи с другими этапами, собранные из `ChunkLink`.

**Связи:**
- `work` — родительская работа (`Work`).
- `tasks` — задачи этапа (`WorkTask`).
- `assigned_engineer` — инженер, назначенный на этап (`Engineer`).
- `data_center` — ДЦ этапа (`DataCenter`).
- `outgoing_links` — исходящие связи (`ChunkLink`), где этот этап — источник.
- `incoming_links` — входящие связи, где этот этап — связанный.

### 4.4. WorkTask

**Таблица:** `work_tasks`

Задача внутри работы (элемент чеклиста или плана работ).

- `id` — UUID, первичный ключ.
- `work_id` — ссылка на работу (`Work.id`).
- `chunk_id` — этап, к которому привязана задача (`WorkChunk.id`, может быть `null`).
- `title` — заголовок задачи.
- `description` — описание (опционально).
- `data_center_id` — ДЦ выполнения (может отличаться от ДЦ работы/этапа).
- `estimated_hours` — оценка длительности одной единицы задачи (в часах).
- `quantity` — количество единиц (например, узлов/серверов/портов).
- `order` — порядок задачи в списке.
- `status` — статус выполнения (`TaskStatus`).
- `completion_note` — комментарий инженера при выполнении (опционально).

**Связи:**
- `work` — родительская работа (`Work`).
- `chunk` — этап (`WorkChunk`), к которому относится задача.
- `data_center` — ДЦ, в котором выполняется задача (`DataCenter`).

### 4.5. WorkAttachment

**Таблица:** `work_attachments`

Вложение (файл), связанное с работой и хранящееся в MinIO.

- `id` — UUID, первичный ключ.
- `work_id` — ссылка на работу (`Work.id`).
- `filename` — оригинальное имя файла.
- `minio_key` — путь/ключ файла в бакете MinIO.
- `content_type` — MIME‑тип файла (опционально).
- `size` — размер файла в байтах.
- `uploaded_by_id` — пользователь (`User.id`), загрузивший файл (опционально).

**Связи:**
- `work` — работа (`Work`), к которой относится вложение.
- `uploaded_by` — пользователь (`User`), загрузивший файл.

### 4.6. ChunkLink

**Таблица:** `chunk_links`

Связь между этапами работы.

- `id` — UUID, первичный ключ.
- `chunk_id` — основной этап (`WorkChunk.id`).
- `linked_chunk_id` — связанный этап (`WorkChunk.id`).
- `link_type` — тип связи (`ChunkLinkType`):
  - `sync` — этапы должны выполняться синхронно (одновременно).
  - `dependency` — зависимость (этап B только после завершения этапа A).

**Связи:**
- `chunk` — исходный этап (имеет `outgoing_links`).
- `linked_chunk` — целевой этап (имеет `incoming_links`).

---

## 5. Сессии массового планирования

### 5.1. PlanningStrategy (для PlanningSession)

Стратегии распределения работ в рамках сессии массового планирования.

- `balanced` — равномерное распределение нагрузки между инженерами.
- `fill_first` — максимальная загрузка одних инженеров, затем переход к другим.
- `priority_first` — сначала критичные и высокоприоритетные работы.
- `optimal` — «умная» стратегия: сочетание минимизации переездов, учёта приоритетов и баланса.

### 5.2. PlanningSessionStatus

Статусы сессии планирования.

- `draft` — черновик, расчёт выполнен, но не применён.
- `applied` — назначения применены, изменения записаны в чанки.
- `cancelled` — сессия отменена.
- `expired` — сессия истекла по TTL.

### 5.3. PlanningSession

**Таблица:** `planning_sessions`

Сессия массового планирования работ и этапов.

- `id` — UUID, первичный ключ.
- `user_id` — пользователь (`User.id`), создавший сессию (может быть `null`).
- `strategy` — выбранная стратегия распределения (`PlanningStrategy`).
- `status` — статус сессии (`PlanningSessionStatus`).
- `expires_at` — момент времени, когда draft‑сессия автоматически истечёт (по умолчанию +30 минут).
- `assignments` — JSON‑массив расчётных назначений, формат записей примерно:
  - `{ chunk_id, engineer_id, date, start_time, dc_id }`.
- `stats` — JSON со статистикой распределения (нагрузка, количество назначений и т.п.).

**Связи:**
- `user` — пользователь (`User`), создавший сессию.

---

## 6. Аудит

### 6.1. AuditAction (enum)

Типы действий для аудита:

- `LOGIN` — успешный вход
- `LOGIN_FAILED` — неудачная попытка входа
- `LOGOUT` — выход
- `TOKEN_REFRESH` — обновление токена
- `USER_CREATED` — создание пользователя
- `USER_UPDATED` — изменение пользователя
- `USER_DELETED` — удаление пользователя
- `USER_BLOCKED` — блокировка пользователя
- `USER_UNBLOCKED` — разблокировка пользователя
- `ROLE_CHANGED` — смена роли
- `PASSWORD_CHANGED` — смена пароля
- `ENGINEER_LINKED` — связывание пользователя с инженером
- `ENGINEER_UNLINKED` — отвязка пользователя от инженера
- `WORK_DELETED` — удаление работы
- `PLANNING_SESSION_APPLIED` — применение сессии планирования

### 6.2. AuditLog

**Таблица:** `audit_logs`

Хранит записи аудита критичных действий.

- `id` — UUID, первичный ключ.
- `user_id` — пользователь, выполнивший действие (`User.id`, может быть NULL для неудачных попыток входа).
- `user_login` — логин пользователя (для удобства просмотра).
- `action` — тип действия (`AuditAction`).
- `entity_type` — тип сущности (user, work, engineer, etc.).
- `entity_id` — ID сущности.
- `details` — дополнительные детали в формате JSON.
- `ip_address` — IP адрес клиента.
- `user_agent` — User-Agent клиента.
- `created_at` — время события.

---

Этот документ можно использовать как справочник по доменной модели при разработке, ревью и написании пользовательской документации.
