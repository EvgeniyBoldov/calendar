# Статусы работ и этапов

Этот документ описывает статусы сущностей **Work** (работа / сопровождение) и **WorkChunk** (этап), а также базовые правила переходов между ними. Статус **документирования** выделен как планируемый этап для завершённых работ.

---

## 1. Статусы Work

### 1.1. Общий набор статусов

Набор статусов для `Work` (как для `general`, так и для `support`):

- `draft`
- `created`
- `ready`
- `scheduling`
- `assigned`
- `in_progress`
- `completed`
- `documented` *(планируемый статус)*

### 1.2. WorkType = general (Работа с планом)

#### Флоу статусов

```text
 draft → ready → scheduling → assigned → in_progress → completed → documented
```

#### Смысл статусов

- **`draft`**
  - План ещё не готов / в процессе составления.
  - Допускаются изменения структуры: задачи, чанки, связи между чанками.
  - Может быть создано без дедлайна.

- **`ready`**
  - План работ готов к планированию.
  - Все необходимые задачи и чанки заведены, зависимости настроены.
  - План можно передать на планирование (ручное/авто).

- **`scheduling`**
  - Работа находится в процессе планирования:
    - идёт ручное распределение чанков по календарю, или
    - запущен авто‑планировщик / массовое планирование.
  - Часть чанков может уже быть назначена, часть — нет.

- **`assigned`**
  - Все необходимые чанки запланированы (назначены инженеры и слоты).
  - План зафиксирован, работа ожидает выполнения.

- **`in_progress`**
  - Есть хотя бы один чанк, который реально выполняется.
  - Работа находится в активном выполнении.

- **`completed`**
  - Все релевантные чанки по работе завершены (`completed`).
  - План выполнен, но документация по результатам ещё может не быть оформлена.

- **`documented`** *(планируемый статус)*
  - Работа завершена **и** задокументирована.
  - Подразумевается, что подготовлены и/или загружены необходимые отчёты, акты, документация.
  - Этот статус нужен, чтобы отличать просто завершённые работы от полностью оформленных.

#### Критерии переходов (general)

- **`draft → ready`**
  - План составлен:
    - есть хотя бы одна задача,
    - есть хотя бы один чанк, и задачи распределены по чанкам,
    - зависимости между чанками не указывают на несуществующие сущности.
  - Инициатор: пользователь (явное действие «План готов» / смена статуса).

- **`ready → scheduling`**
  - Старт процесса планирования:
    - пользователь отправил работу на планирование,
    - или запущено авто‑планирование (например, `assign_all_chunks` / массовое).
  - Условие: есть хотя бы один чанк в статусе `created`.

- **`scheduling → assigned`**
  - Все необходимые чанки получили назначения:
    - у каждого есть `assignedEngineerId`, `assignedDate`, `assignedStartTime`,
    - статусы чанков не ниже `planned` (обычно `planned` / `assigned`).
  - Инициатор: сервис планирования или ручная фиксация результата планирования.

- **`assigned → in_progress`**
  - Первый чанк по работе переведён в `in_progress`.
  - Инициатор: действие инженера/оператора или сервис, отслеживающий начало выполнения.

- **`in_progress → completed`**
  - Все чанки по работе находятся в статусе `completed`.
  - Инициатор: автоматический (по факту завершения последнего чанка) или ручной.

- **`completed → documented`**
  - Документация по выполненной работе оформлена:
    - загружены файлы (акты, отчёты и т.п.),
    - заполнены необходимые поля в системе (например, ссылки на документы, номера актов).
  - Инициатор: обычно ответственный за документацию/проект.

- **Обратные переходы (по необходимости)**
  - Возможны откаты в особых случаях (по ролям):
    - `ready → draft` (если план оказался неполным),
    - `scheduling → ready` (отмена процесса планирования),
    - `assigned → scheduling` (нужно перепланирование),
    - `documented → completed` (если документацию нужно переделать).

### 1.3. WorkType = support (Сопровождение)

#### Флоу статусов

```text
 created → scheduling → assigned → in_progress → completed → documented
```

#### Смысл статусов

- **`created`**
  - Сопровождение заведено.
  - Минимальный набор данных:
    - `dataCenterId` (ДЦ),
    - `targetDate`,
    - `durationHours` (1–12),
    - опционально `targetTime`, `contactInfo`.
  - При создании автоматически создаётся один чанк и одна задача под эту работу.

- **`scheduling`**
  - Сопровождение передано на планирование (подбор инженера и точного слота).

- **`assigned`**
  - Сопровождение назначено конкретному инженеру в конкретный слот:
    - у связанного чанка есть `assignedEngineerId`, `assignedDate`, `assignedStartTime`.

- **`in_progress`**
  - Инженер выехал / работы по сопровождению начались (чанк в `in_progress`).

- **`completed`**
  - Работы по сопровождению завершены, чанк в статусе `completed`.

- **`documented`** *(планируемый статус)*
  - Сопровождение завершено и задокументировано (отчёты, акты, комментарии и т.п.).

#### Критерии переходов (support)

- **`created → scheduling`**
  - Сопровождение отправлено на планирование (ручное действие или запуск авто‑планировщика).
  - Условия:
    - заполнены `dataCenterId`, `targetDate`, `durationHours`.

- **`scheduling → assigned`**
  - Планировщик/оператор выбрал слот, и чанк получил назначение:
    - `assignedEngineerId`, `assignedDate`, `assignedStartTime`.

- **`assigned → in_progress`**
  - Инженер начал выполнение сопровождения (чанк переведён в `in_progress`).

- **`in_progress → completed`**
  - Чанк завершён (`completed`), при необходимости заполнена отчётная информация.

- **`completed → documented`**
  - Оформлена документация по сопровождению (акты, отчёты, прикреплённые файлы и т.п.).

---

## 2. Статусы WorkChunk (Этап)

Общий набор статусов этапа:

```text
 created → planned → assigned → in_progress → completed
```

### 2.1. Смысл статусов

- **`created`**
  - Этап существует в плане, но не имеет назначения в календаре.
  - Нет `assignedEngineerId` / `assignedDate` / `assignedStartTime`.

- **`planned`**
  - Для этапа найден кандидатный слот авто‑планировщиком, но он ещё может требовать подтверждения.
  - Используется для отображения «предложенного» назначения.

- **`assigned`**
  - Назначение подтверждено:
    - зафиксированы `assignedEngineerId`, `assignedDate`, `assignedStartTime`.
  - Любые изменения далее считаются изменением графика.

- **`in_progress`**
  - Инженер выполняет работы по этому этапу.

- **`completed`**
  - Этап полностью выполнен.
  - Задачи в рамках этапа не имеют незакрытых `todo` без объяснения (детали зависят от бизнес‑правил).

### 2.2. Критерии переходов

- **`created → planned`**
  - Авто‑планировщик (`assign_chunk`, массовое планирование) нашёл слот для этапа.
  - Поля назначения заполнены, статус переведён в `planned`.

- **`planned → assigned`**
  - Пользователь подтверждает предложенный слот (например, через UI «Подтвердить назначение»).
  - Статус этапа меняется на `assigned`.

- **`created → assigned`** (прямой путь)
  - Ручное назначение этапа в календаре без промежуточного `planned`.
  - Слот сразу считается подтверждённым.

- **`planned → created` / `assigned → created`**
  - Отмена назначения (unassign):
    - поля `assigned*` очищаются,
    - статус возвращается в `created`.
  - Операция должна быть идемпотентной (повторный вызов не ломает состояние).

- **`assigned → in_progress`**
  - Инженер начинает выполнение этапа (явное действие или автоматический триггер по времени).

- **`in_progress → completed`**
  - Этап завершён, инженер/оператор отмечает его выполненным.

---

## 3. Связь статусов Work и WorkChunk

### 3.1. WorkType = general

Для работ с планом статус `Work` может определяться агрегированием статусов чанков:

- Если есть хотя бы один чанк в `in_progress` → `work.status` минимум `in_progress`.
- Если все чанки в `completed` → `work.status = completed` (или `documented`, если оформлена документация).
- Если есть назначенные чанки (`planned` / `assigned`), но ни один не в `in_progress` → `work.status` минимум `assigned`.
- Если идёт активное планирование и есть неназначенные чанки → `work.status = scheduling`.

### 3.2. WorkType = support

Для сопровождения, где фактически один «основной» чанк, статус работы может напрямую следовать за статусом этапа:

- `created` (work) ↔ чанк в `created`.
- `scheduling` / `assigned` (work) ↔ чанк в `planned` / `assigned`.
- `in_progress` (work) ↔ чанк в `in_progress`.
- `completed` / `documented` (work) ↔ чанк в `completed` + состояние документации.
